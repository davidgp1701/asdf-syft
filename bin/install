#!/usr/bin/env bash

set -euo pipefail

# Based on: https://github.com/luizm/asdf-shellcheck/blob/master/bin/install

ASDF_INSTALL_TYPE=${ASDF_INSTALL_TYPE:-version  }

test -n "$ASDF_INSTALL_VERSION" || {
  echo 'Missing ASDF_INSTALL_VERSION'
  exit 1
}

test -n "$ASDF_INSTALL_PATH" || {
  echo 'Missing ASDF_INSTALL_PATH'
  exit 1
}

_get_arch() {
  local arch
  arch=$(uname -m)
  case $arch in
  # Note: Tool is only provided in AMD64 for the moment
  # armv*) arch="armv6hf";;
  # aarch64) arch="aarch64";;
  x86_64)
    arch="amd64"
    ;;
  esac
  echo "$arch"
}

_get_platform() {
  uname | tr '[:upper:]' '[:lower:]'
}

_get_download_url() {
  local -r version="$1"
  local -r platform="$2"
  local -r arch="$3"
  local -r ext="$4"
  local -r url="https://github.com/anchore/syft/releases/download/v${version}/syft_${version}_${platform}_${arch}${ext}"

  echo "${url}"
}

install() {
  local -r version=$1
  local -r install_path=$2
  echo "${version}, ${install_path}"

  local -r platform="$(_get_platform)"
  local -r arch="$(_get_arch)"
  local -r download_url="$(_get_download_url "$version" "$platform" "$arch" ".tar.gz")"
  echo "${download_url}"
}

install "$ASDF_INSTALL_VERSION" "$ASDF_INSTALL_PATH"
