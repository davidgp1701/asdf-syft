#!/usr/bin/env bash

set -euo pipefail

# Based on: https://github.com/luizm/asdf-shellcheck/blob/master/bin/install

ASDF_INSTALL_TYPE=${ASDF_INSTALL_TYPE:-version  }

test -n "$ASDF_INSTALL_VERSION" || {
  echo 'Missing ASDF_INSTALL_VERSION'
  exit 1
}

test -n "$ASDF_INSTALL_PATH" || {
  echo 'Missing ASDF_INSTALL_PATH'
  exit 1
}

_get_arch() {
  local arch
  arch=$(uname -m)
  case $arch in
  # Note: Tool is only provided in AMD64 for the moment
  # armv*) arch="armv6hf";;
  # aarch64) arch="aarch64";;
  x86_64)
    arch="amd64"
    ;;
  esac
  echo "$arch"
}

_get_platform() {
  uname | tr '[:upper:]' '[:lower:]'
}

_get_download_url() {
  local -r version="$1"
  local -r platform="$2"
  local -r arch="$3"
  local -r ext="$4"
  local -r url="https://github.com/anchore/syft/releases/download/v${version}/syft_${version}_${platform}_${arch}${ext}"

  echo "${url}"
}

install() {
  local -r version=$1
  local -r install_path=$2
  echo "${version}, ${install_path}"

  local -r platform="$(_get_platform)"
  local -r arch="$(_get_arch)"

  local -r tarball_url="$(_get_download_url "$version" "$platform" "$arch" ".tar.gz")"
  local -r zip_url="$(_get_download_url "$version" "$platform" "$arch" ".zip")"

  case $platform in
  linux)
    install_tarball "$install_path" "$tarball_url"
    ;;
  darwin)
    local -r code=$(curl -o /dev/null --silent -LIw '%{http_code}' "${tarball_url}")
    if [ "$code" = "200" ]
    then
      install_tarball "$install_path" "$tarball_url"
    else
      install_zip "$install_path" "$zip_url"
    fi
    ;;
  esac
}

install_tarball() {
  local -r install_path=$1
  local -r url=$2

  local -r tar_install_path="$install_path/syft-v$version.tgz"
  local -r bin_install_path="$install_path/bin"
  local -r bin_path="$bin_install_path/syft"

  mkdir -p "$bin_install_path"
  local tmp_dir
  tmp_dir="$(mktemp -d)"

  echo "Downloading syft from $url"
  curl -Ls "$url" -o "$tar_install_path"
  tar -xf "$tar_install_path" -C "$tmp_dir"
  cp "${tmp_dir}/syft" "$bin_path"
  rm -rf "$tar_install_path"
  rm -rf "$tmp_dir"
  chmod +x "$bin_path"
}

install_zip() {
  local -r install_path=$1
  local -r url=$2

  local -r zip_install_path="$install_path/syft-v$version.zip"
  local -r bin_install_path="$install_path/bin"
  local -r bin_path="$bin_install_path/syft"

  mkdir -p "$bin_install_path"
  local tmp_dir
  tmp_dir="$(mktemp -d)"

  echo "Downloading syft from $url"
  curl -Ls "$url" -o "$zip_install_path"
  unzip "$zip_install_path" -d "$tmp_dir"
  cp "${tmp_dir}/syft" "$bin_path"
  rm -rf "$zip_install_path"
  rm -rf "$tmp_dir"
  chmod +x "$bin_path"
}

install "$ASDF_INSTALL_VERSION" "$ASDF_INSTALL_PATH"
